(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{common:()=>K,forum:()=>nt});const o=flarum.core.compat["forum/app"];var n=t.n(o);function r(t,e){return r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},r(t,e)}function s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,r(t,e)}const a=flarum.core.compat["common/components/LoadingIndicator"];var i=t.n(a);const l=flarum.core.compat["common/helpers/icon"];var c=t.n(l);const u=flarum.core.compat["common/app"];var f=t.n(u);const d=flarum.core.compat["common/components/Modal"];var p=t.n(d);const h=flarum.core.compat["forum/components/DiscussionPage"];var y=t.n(h);const x=flarum.core.compat["common/components/Button"];var v=t.n(x);const g=flarum.core.compat["common/components/Switch"];var T=t.n(g);const b=flarum.core.compat["common/helpers/highlight"];var I=t.n(b);const w=flarum.core.compat["common/utils/classList"];var k=t.n(w);const S=flarum.core.compat["common/utils/ItemList"];var L=t.n(S);const C=flarum.core.compat["common/utils/extractText"];var E=t.n(C);const F=((flarum.extensions["flamarkt-backoffice"]||{}).common||{})["utils/KeyboardNavigatable"];var A=t.n(F);const P=flarum.core.compat["common/utils/extract"];var D=t.n(P);const O=flarum.core.compat["common/Model"];var N=t.n(O),q=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name=N().attribute("name"),e.slug=N().attribute("slug"),e.description=N().attribute("description"),e.color=N().attribute("color"),e.icon=N().attribute("icon"),e.order=N().attribute("order"),e.createdAt=N().attribute("createdAt",N().transformDate),e.taxonomy=N().hasOne("taxonomy"),e}return s(e,t),e.prototype.apiEndpoint=function(){return"/flamarkt/taxonomy-terms"+(this.exists?"/"+this.data.id:"")},e}(N());function M(t,e,o){void 0===e&&(e={}),void 0===o&&(o={});var n=t&&t.icon(),r=o.useColor,s=void 0===r||r;return e.className=k()([e.className,"icon",n?t.icon():"TaxonomyIcon"]),t?(e.style=e.style||{},n?e.style.color=s?t.color():"":e.style.backgroundColor=t.color()):e.className+=" untagged",n?m("i",e):m("span",e)}function B(t,e){void 0===t&&(t=null),void 0===e&&(e={}),e.style=e.style||{},e.className="TaxonomyLabel "+(e.className||"");var o=D()(e,"discussionLink"),n=D()(e,"userLink"),r=t?t.name():f().translator.trans("flarum-tags.lib.deleted_tag_text"),s="span";if(t){var a,i=t.color();if(i&&(e.style.backgroundColor=e.style.color=i,e.className+=" colored"),t instanceof q&&t.taxonomy()&&t.taxonomy().canSearch())o&&(e.title=t.description()||"",e.href=f().route("index",((a={})[t.taxonomy().slug()]=t.slug(),a)),e.config=m.route,s="a"),n&&f().routes.fof_user_directory&&(e.title=t.description()||"",e.href=f().route("fof_user_directory",{q:"taxonomy:"+t.taxonomy().slug()+":"+t.slug()}),e.config=m.route,s="a")}else e.className+=" untagged";return m(s,e,m("span.TaxonomyLabel-text",[t&&t.icon()&&M(t,{},{useColor:!1})," "+r]))}function _(){return _=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n])}return t},_.apply(this,arguments)}function U(t){return t.id()?N().getIdentifier(t):_({},N().getIdentifier(t),{attributes:{name:t.name()}})}var R=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).availableTerms=null,e.selectedTerms=[],e.searchFilter="",e.activeListIndex=0,e.inputIsFocused=!1,e.saving=!1,e.bypassReqs=!1,e.navigator=void 0,e}s(e,t);var o=e.prototype;return o.oninit=function(e){var o=this;t.prototype.oninit.call(this,e),this.attrs.selectedTerms?this.attrs.selectedTerms.forEach(this.addTerm.bind(this)):this.attrs.resource&&this.attrs.resource.taxonomyTerms().forEach((function(t){t.taxonomy().id()===o.attrs.taxonomy.id()&&o.addTerm(t)})),f().request({method:"GET",url:f().forum.attribute("apiUrl")+this.attrs.taxonomy.apiEndpoint()+"/terms"}).then((function(t){o.availableTerms=f().store.pushPayload(t),m.redraw()})),this.navigator=new(A()),this.navigator.onUp((function(){return o.setIndex(o.activeListIndex-1,!0)})).onDown((function(){return o.setIndex(o.activeListIndex+1,!0)})).onSelect(this.select.bind(this)).onRemove((function(){o.selectedTerms.length&&o.toggleTerm(o.selectedTerms[o.selectedTerms.length-1])})).when((function(t){return" "!==t.key||""!==o.searchFilter||(t.preventDefault(),o.select(t),!1)}))},o.indexInSelectedTerms=function(t){return this.selectedTerms.findIndex((function(e){return n=t,(o=e).data.type===n.data.type&&(o.id()&&n.id()?o.id()===n.id():!o.id()==!n.id()&&o.name()===n.name());var o,n}))},o.addTerm=function(t){this.selectedTerms.push(t)},o.removeTerm=function(t){var e=this.indexInSelectedTerms(t);-1!==e&&this.selectedTerms.splice(e,1)},o.className=function(){return"ChooseTaxonomyTermsModal"},o.title=function(){return this.attrs.resource?f().translator.trans("flamarkt-taxonomies.lib.modal.title.edit",{taxonomy:this.attrs.taxonomy.name(),title:m("em",this.attrs.resource.title?this.attrs.resource.title():this.attrs.resource.displayName())}):f().translator.trans("flamarkt-taxonomies.lib.modal.title.new",{taxonomy:this.attrs.taxonomy.name()})},o.getInstruction=function(){if(this.bypassReqs)return"";var t=this.selectedTerms.length;if(this.attrs.taxonomy.minTerms()&&t<this.attrs.taxonomy.minTerms()){var e=this.attrs.taxonomy.minTerms()-t;return f().translator.trans("flamarkt-taxonomies.lib.modal.placeholder",{count:e})}return 0===t?f().translator.trans("flamarkt-taxonomies.lib.modal.placeholderOptional"):""},o.filteredAvailableTerms=function(){var t=null===this.availableTerms?[]:this.availableTerms,e=this.searchFilter.toLowerCase();if(e&&(t=t.filter((function(t){return t.name().substr(0,e.length).toLowerCase()===e})),this.attrs.taxonomy.allowCustomValues()&&!t.some((function(t){return t.name().toLowerCase()===e})))){var o=this.attrs.taxonomy.customValueValidation(),n=null;if("alpha_num"===o)n=/^[a-z0-9]$/i;else if("alpha_dash"===o)n=/^[a-z0-9_-]$/i;else if(0===o.indexOf("/")){var r=o.split("/");3===r.length&&(n=new RegExp(r[1],r[2]))}n&&!n.test(this.searchFilter)||t.push(f().store.createRecord("flamarkt-taxonomy-terms",{attributes:{name:this.searchFilter}}))}return!this.bypassReqs&&this.attrs.taxonomy.maxTerms()&&this.selectedTerms.length>=this.attrs.taxonomy.maxTerms()&&(t=[]),t},o.content=function(){return this.contentItems().toArray()},o.contentItems=function(){var t=this,e=new(L());return e.add("form",this.viewForm(),20),e.add("terms",this.listAvailableTerms(this.filteredAvailableTerms()),10),this.attrs.taxonomy.canBypassTermCounts()&&(this.attrs.taxonomy.minTerms()||this.attrs.taxonomy.maxTerms())&&e.add("bypass",m(".Modal-body.ChooseTaxonomyTermsModal-form-bypass",T().component({state:this.bypassReqs,onchange:function(e){t.bypassReqs=e}},f().translator.trans("flamarkt-taxonomies.lib.modal.bypassTermCounts"))),-10),e},o.viewForm=function(){var t=this.attrs.taxonomy.description();return m(".Modal-body",[t?m("p",t):null,m(".ChooseTaxonomyTermsModal-form",this.formItems().toArray())])},o.formItems=function(){var t=new(L());return t.add("input",m(".ChooseTaxonomyTermsModal-form-input",m(".TermsInput.FormControl",{className:this.inputIsFocused?"focus":""},this.inputItems().toArray())),20),t.add("submit",m(".ChooseTaxonomyTermsModal-form-submit.App-primaryControl",v().component({type:"submit",className:"Button Button--primary",disabled:!this.bypassReqs&&this.attrs.taxonomy.minTerms()&&this.selectedTerms.length<this.attrs.taxonomy.minTerms(),icon:"fas fa-check",loading:this.saving},f().translator.trans("flamarkt-taxonomies.lib.modal.submit"))),10),t},o.inputItems=function(){var t=this,e=new(L());return e.add("selected",this.selectedTerms.map((function(e){return m("span.TermsInput-term",{onclick:function(){t.toggleTerm(e),t.onready()}},B(e))})),20),e.add("control",m("input.FormControl",{placeholder:E()(this.getInstruction()),value:this.searchFilter,oninput:function(e){t.searchFilter=e.target.value,t.activeListIndex=0},onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:this.oninputfocus.bind(this),onblur:this.oninputblur.bind(this)}),10),e},o.oninputfocus=function(){this.inputIsFocused=!0},o.oninputblur=function(){this.inputIsFocused=!1},o.listAvailableTerms=function(t){return m(".Modal-footer",null===this.availableTerms?i().component():m("ul.ChooseTaxonomyTermsModal-list.SelectTermList",{className:t.some((function(t){return t.description()}))?"SelectTermList--with-descriptions":""},t.map(this.listAvailableTerm.bind(this))))},o.listAvailableTerm=function(t,e){var o=this;return m("li.SelectTermListItem",{"data-index":e,className:k()({colored:!!t.color(),selected:-1!==this.indexInSelectedTerms(t),active:this.activeListIndex===e}),style:{color:t.color()},onmouseover:function(){return o.activeListIndex=e},onclick:this.toggleTerm.bind(this,t)},[M(t),m("span.SelectTermListItem-name",t.exists?I()(t.name(),this.searchFilter):f().translator.trans("flamarkt-taxonomies.lib.modal.custom",{value:m("em",t.name())})),t.description()?m("span.SelectTermListItem-description",t.description()):""])},o.toggleTerm=function(t){var e=this;-1!==this.indexInSelectedTerms(t)?this.removeTerm(t):this.addTerm(t),this.searchFilter&&(this.searchFilter="",this.activeListIndex=0),setTimeout((function(){e.onready()}))},o.select=function(t){var e=this.getDomElement(this.activeListIndex);e.length?t.metaKey||t.ctrlKey||e.is(".selected")?this.selectedTerms.length&&this.onsubmit():e[0].dispatchEvent(new Event("click")):this.searchFilter=""},o.getDomElement=function(t){return this.$('.SelectTermListItem[data-index="'+t+'"]')},o.setIndex=function(t,e){var o=this.$(".ChooseTaxonomyTermsModal-list"),n=this.$(".SelectTermListItem").length;t<0?t=n-1:t>=n&&(t=0);var r=this.getDomElement(t);if(this.activeListIndex=t,m.redraw(),e){var s,a,i,l=o.scrollTop()||0,c=(null==(s=o.offset())?void 0:s.top)||0,u=c+(o.outerHeight()||0),f=(null==(a=r.offset())?void 0:a.top)||0,d=f+(r.outerHeight()||0);f<c?i=l-c+f-parseInt(o.css("padding-top"),10):d>u&&(i=l-u+d+parseInt(o.css("padding-bottom"),10)),void 0!==i&&o.stop(!0).animate({scrollTop:i},100)}},o.onsubmit=function(t){t&&t.preventDefault(),this.attrs.resource?this.saveResource():(this.attrs.onsubmit&&this.attrs.onsubmit(this.selectedTerms),f().modal.close())},o.saveResource=function(){this.saving=!0,this.attrs.resource.save({relationships:{taxonomies:[{verbatim:!0,type:"flamarkt-taxonomies",id:this.attrs.taxonomy.id(),relationships:{terms:{data:this.selectedTerms.map(U)}}}]}}).then(this.onsaved.bind(this),this.onerror.bind(this))},o.onsaved=function(){y()&&f().current.matches(y())&&f().current.get("stream").update(),this.saving=!1,m.redraw(),f().modal.close()},o.onerror=function(){this.saving=!1,m.redraw()},e}(p()),V=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).lastSaveState="neutral",e.dropdownIsFocused=!1,e.onmousedown=void 0,e}s(e,t);var o=e.prototype;return o.oninit=function(e){var o=this;t.prototype.oninit.call(this,e),this.navigator.when((function(t){return" "===t.key&&""===o.searchFilter?(t.preventDefault(),o.select(t),!1):"Tab"!==t.key}))},o.oncreate=function(t){var e=this;this.element=t.dom,this.onmousedown=function(o){var n=t.dom.querySelector(".Dropdown-menu");n&&n.contains(o.target)?e.dropdownIsFocused||(e.dropdownIsFocused=!0,m.redraw()):e.dropdownIsFocused&&(e.dropdownIsFocused=!1,m.redraw())},document.addEventListener("mousedown",this.onmousedown)},o.onbeforeremove=function(){},o.onremove=function(e){t.prototype.onremove.call(this,e),document.removeEventListener("mousedown",this.onmousedown)},o.view=function(){var t=this.attrs.taxonomy.description();return m(".ChooseTaxonomyTermsDropdown",m("form",{onsubmit:function(t){t.preventDefault()}},[m(".ChooseTaxonomyTermsInput",[m(".ChooseTaxonomyTermsModal-form",this.formItems().toArray()),this.listAvailableTerms(this.filteredAvailableTerms())]),t?m("p",t):null]))},o.formItems=function(){var e=t.prototype.formItems.call(this);e.remove("submit");var o=null;return this.saving?o=i().component():"success"===this.lastSaveState?o=c()("fas fa-check"):"error"===this.lastSaveState&&(o=c()("fas fa-times")),e.add("status",m(".ChooseTaxonomyTermsStatus",o)),e},o.listAvailableTerms=function(t){return!this.inputIsFocused&&!this.dropdownIsFocused||0===t.length?null:(e=null===this.availableTerms?i().component():t.map(this.listAvailableTerm.bind(this)),m("ul.Dropdown-menu.ChooseTaxonomyTermsModal-list",e));var e},o.listAvailableTerm=function(e,o){return m("li",t.prototype.listAvailableTerm.call(this,e,o))},o.toggleTerm=function(e){t.prototype.toggleTerm.call(this,e),this.lastSaveState="neutral",this.saveResource()},o.select=function(t){var e=this.getDomElement(this.activeListIndex);e.length?e[0].dispatchEvent(new Event("click")):this.searchFilter=""},o.onsaved=function(){this.lastSaveState="success",t.prototype.onsaved.call(this)},o.onerror=function(){this.lastSaveState="error",t.prototype.onerror.call(this)},e}(R);function j(t){return!1===t&&(t=[]),t.slice(0).sort((function(t,e){var o=t.order()-e.order();return 0!==o?o:t.name()>e.name()?1:t.name()<e.name()?-1:0}))}function z(t){return t.slice(0).sort((function(t,e){var o=t.order()-e.order();return 0!==o?o:t.name()>e.name()?1:t.name()<e.name()?-1:0}))}function $(t,e){void 0===e&&(e={});var o=[],n=D()(e,"discussionLink"),r=D()(e,"userLink");if(e.className="TaxonomiesLabel "+(e.className||""),t){var s=D()(e,"taxonomy");s||(s=t[0].taxonomy()),s&&(e["data-slug"]=s.slug(),s.showLabel()&&o.push(B(s,{className:"TaxonomyParentLabel"}))),z(t).forEach((function(e){(e||1===t.length)&&o.push(B(e,{discussionLink:n,userLink:r}))}))}else o.push(B());return m("span",e,o)}function H(t,e){void 0===e&&(e={});var o=[];return t.forEach((function(t){var e=t.taxonomy();e&&-1===o.indexOf(e)&&o.push(e)})),j(o).map((function(o){return $(t.filter((function(t){return t.taxonomy()===o})),_({},e))}))}var G=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).type=N().attribute("type"),e.name=N().attribute("name"),e.slug=N().attribute("slug"),e.description=N().attribute("description"),e.color=N().attribute("color"),e.icon=N().attribute("icon"),e.order=N().attribute("order"),e.showLabel=N().attribute("showLabel"),e.showFilter=N().attribute("showFilter"),e.enableFilter=N().attribute("enableFilter"),e.enableFulltextSearch=N().attribute("enableFulltextSearch"),e.allowCustomValues=N().attribute("allowCustomValues"),e.customValueValidation=N().attribute("customValueValidation"),e.customValueSlugger=N().attribute("customValueSlugger"),e.minTerms=N().attribute("minTerms"),e.maxTerms=N().attribute("maxTerms"),e.createdAt=N().attribute("createdAt",N().transformDate),e.canSearch=N().attribute("canSearch"),e.canBypassTermCounts=N().attribute("canBypassTermCounts"),e.tagIds=N().attribute("tagIds"),e}s(e,t);var o=e.prototype;return o.apiEndpoint=function(){return"/flamarkt/taxonomies"+(this.exists?"/"+this.data.id:"")},o.apiOrderEndpoint=function(){return this.apiEndpoint()+"/terms/order"},o.apiTermsEndpoint=function(){return this.apiEndpoint()+"/terms"},e}(N()),K={"components/ChooseTaxonomyTermsDropdown":V,"components/ChooseTaxonomyTermsModal":R,"helpers/labelsFromMultipleTaxonomiesList":H,"helpers/taxonomyIcon":M,"helpers/termLabel":B,"helpers/termsLabel":$,"models/Taxonomy":G,"models/Term":q,"utils/sortTaxonomies":j,"utils/sortTerms":z,"utils/termToIdentifier":U};const W=flarum.core.compat["common/Component"];var J=t.n(W);const Q=flarum.core.compat["common/components/Dropdown"];var X=t.n(Q),Y=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).termsInitialized=!1,e.terms=null,e}s(e,t);var o=e.prototype;return o.oninit=function(e){t.prototype.oninit.call(this,e),this.attrs.activeTermSlug&&this.loadTerms()},o.loadTerms=function(){var t=this;this.termsInitialized||(this.termsInitialized=!0,n().request({method:"GET",url:n().forum.attribute("apiUrl")+this.attrs.taxonomy.apiTermsEndpoint()}).then((function(e){t.terms=n().store.pushPayload(e),t.terms.forEach((function(e){e.pushData({relationships:{taxonomy:t.attrs.taxonomy}})})),m.redraw()})))},o.view=function(){var t=this,e=this.terms&&this.terms.find((function(e){return e.slug()===t.attrs.activeTermSlug}));return X().component({buttonClassName:"Button",label:this.attrs.taxonomy.name()+(e?": "+e.name():""),onshow:function(){t.loadTerms()}},null===this.terms?[i().component()]:this.terms.map((function(e){var o=t.attrs.activeTermSlug===e.slug();return v().component({icon:!o||"fas fa-check",onclick:function(){return t.attrs.onchange(e)},active:o},e.name())})))},e}(J());const Z=flarum.core.compat["forum/components/UserPage"];var tt=t.n(Z),et=function(t){function e(){return t.apply(this,arguments)||this}s(e,t);var o=e.prototype;return o.oninit=function(e){t.prototype.oninit.call(this,e),this.loadUser(m.route.param("username"))},o.content=function(){var t=this.user.taxonomyTerms();if(!t||!t.length)return null;var e=[];return t.forEach((function(t){var o=t.taxonomy();o&&-1===e.indexOf(o)&&e.push(o)})),j(e).map((function(e){return[m("h2",e.name()),$(t.filter((function(t){return t.taxonomy()===e})),{userLink:!0})]}))},e}(tt());function ot(t,e){return void 0===e&&(e=!1),function(o){return o.type()===t&&o.canSearch()&&(o.showFilter()||e)}}var nt={"components/TaxonomyDropdown":Y,"components/UserTaxonomyPage":et,"utils/showsFilterFor":ot};const rt=flarum.core.compat["common/extend"],st=flarum.core.compat["forum/components/DiscussionComposer"];var at=t.n(st);function it(t,e){if(!n().forum.attribute("canUseTaxonomiesOnNewDiscussion"))return!1;if(0===t.tagIds().length)return!0;var o=e.composer.fields.tags;return!!Array.isArray(o)&&o.some((function(e){return-1!==t.tagIds().indexOf(e.id())}))}const mt=flarum.core.compat["forum/utils/DiscussionControls"];var lt=t.n(mt);function ct(t,e){e.attribute("canEditTaxonomies")&&j(n().forum.taxonomies()).forEach((function(o){if("discussions"===o.type()){if(o.tagIds().length){if(!("flarum-tags"in flarum.extensions))return;var r=e.tags();if(!Array.isArray(r))return;if(!r.some((function(t){return-1!==o.tagIds().indexOf(t.id())})))return}t.add("taxonomy-"+o.slug(),v().component({icon:"fas fa-tag",onclick:function(){return n().modal.show(R,{resource:e,taxonomy:o})}},n().translator.trans("flamarkt-taxonomies.forum.discussion.edit",{taxonomy:o.name()})))}}))}const ut=flarum.core.compat["forum/components/IndexPage"];var ft=t.n(ut);const dt=flarum.core.compat["forum/states/DiscussionListState"];var pt=t.n(dt);const ht=flarum.core.compat["forum/states/GlobalSearchState"];var yt=t.n(ht);const xt=flarum.core.compat["forum/components/DiscussionListItem"];var vt=t.n(xt);const gt=flarum.core.compat["forum/components/DiscussionHero"];var Tt=t.n(gt);const bt=((flarum.extensions["flamarkt-core"]||{}).forum||{})["layouts/ProductIndexLayout"];var It=t.n(bt);const wt=((flarum.extensions["flamarkt-core"]||{}).forum||{})["pages/ProductIndexPage"];var kt=t.n(wt);const St=flarum.core.compat["forum/utils/UserControls"];var Lt=t.n(St);const Ct=flarum.core.compat["common/components/LinkButton"];var Et=t.n(Ct);const Ft=flarum.core.compat["common/models/Discussion"];var At=t.n(Ft);const Pt=flarum.core.compat["common/models/Forum"];var Dt=t.n(Pt);const Ot=flarum.core.compat["common/models/User"];var Nt=t.n(Ot);const qt=((flarum.extensions["flamarkt-core"]||{}).common||{})["models/Product"];var Mt=t.n(qt);n().initializers.add("flamarkt-taxonomies",(function(){"v17development/blog/components/BlogItemSidebar"in flarum.core.compat&&(0,rt.extend)(flarum.core.compat["v17development/blog/components/BlogItemSidebar"].prototype,"items",(function(t){t.setPriority("author",50),t.setPriority("categories",30);var e=this.attrs.article;if(e){var o=e.taxonomyTerms();o&&o.length&&t.add("taxonomies",m(".BlogTaxonomies.BlogSideWidget",[m("h3",n().translator.trans("flamarkt-taxonomies.forum.blog.widget.title")),m(".BlogTaxonomiesContainer",H(o,{discussionLink:!0}))]),29)}})),(0,rt.extend)(at().prototype,"oninit",(function(){this.composer.fields.taxonomyTerms||(this.composer.fields.taxonomyTerms={})})),(0,rt.extend)(at().prototype,"headerItems",(function(t){var e=this;j(n().forum.taxonomies()).forEach((function(o){var r=o.id();"discussions"===o.type()&&r&&it(o,e)&&t.add("taxonomy-"+o.slug(),m("a.DiscussionComposer-changeTaxonomies",{"data-taxonomy-name":o.name(),href:"#",onclick:function(t){t.preventDefault(),n().modal.show(R,{taxonomy:o,selectedTerms:(e.composer.fields.taxonomyTerms[r]||[]).slice(0),onsubmit:function(t){e.composer.fields.taxonomyTerms[o.id()]=t,e.$("textarea").trigger("focus")}})}},e.composer.fields.taxonomyTerms[r]&&e.composer.fields.taxonomyTerms[r].length?$(e.composer.fields.taxonomyTerms[r],{taxonomy:o}):m("span.TaxonomyLabel.untagged",[o.icon()?[c()(o.icon())," "]:null,n().translator.trans("flamarkt-taxonomies.forum.composer.choose",{taxonomy:o.name()})])),9)}))})),(0,rt.override)(at().prototype,"onsubmit",(function(t){var e=this,o=[];if(j(n().forum.taxonomies()).forEach((function(t){var r=t.id();if("discussions"===t.type()&&r&&it(t,e)){var s=(e.composer.fields.taxonomyTerms[r]||[]).length;t.minTerms()&&s<t.minTerms()&&o.push((function(o){n().modal.show(R,{taxonomy:t,selectedTags:(e.composer.fields.taxonomyTerms[r]||[]).slice(0),onsubmit:function(t){e.composer.fields.taxonomyTerms[r]=t,o()}})}))}})),o.length){var r=function e(){o.length?new Promise(o.shift()).then((function(){setTimeout((function(){e()}),400)})):t()};n().modal.modal?setTimeout((function(){r()}),400):r()}else t()})),(0,rt.extend)(at().prototype,"data",(function(t){var e=this,o=[];(n().forum.taxonomies()||[]).forEach((function(t){var n=t.id();"discussions"===t.type()&&n&&it(t,e)&&e.composer.fields.taxonomyTerms[n]&&e.composer.fields.taxonomyTerms[n].length&&o.push({verbatim:!0,type:"flamarkt-taxonomies",id:n,relationships:{terms:{data:e.composer.fields.taxonomyTerms[n].map(U)}}})})),t.relationships=t.relationships||{},t.relationships.taxonomies=o})),(0,rt.extend)(at().prototype,"view",(function(t){(this.taxonomiesHeaderItemsCount||0)<5||(t.children||[]).forEach((function(t){t&&t.attrs&&t.attrs.className&&-1!==t.attrs.className.indexOf("ComposerBody ")&&(t.attrs.className+=" ComposerBody--taxonomies-compact")}))})),(0,rt.extend)(lt(),"moderationControls",(function(t,e){ct(t,e)})),"v17development/blog/components/BlogPostController"in flarum.core.compat&&(0,rt.extend)(flarum.core.compat["v17development/blog/components/BlogPostController"].prototype,"manageArticleButtons",(function(t){ct(t,this.attrs.article)})),(0,rt.extend)(ft().prototype,"viewItems",(function(t){var e=this;j(n().store.all("flamarkt-taxonomies")).filter(ot("discussions")).forEach((function(o){if(1===o.tagIds().length&&"flarum-tags"in flarum.extensions){var r=e.currentTag();if(!r)return;if(-1===o.tagIds().indexOf(r.id())){var s=r.parent();if(!s)return;if(-1===o.tagIds().indexOf(s.id()))return}}t.add("taxonomy-"+o.slug(),Y.component({taxonomy:o,activeTermSlug:n().search.params()[o.slug()],onchange:function(t){var r=n().search.params(),s=r[o.slug()];t.slug()===s?delete r[o.slug()]:r[o.slug()]=t.slug();var a=e.attrs.routeName;m.route.set(n().route(a,r))}}))}))})),(0,rt.extend)(yt().prototype,"stickyParams",(function(t){j(n().store.all("flamarkt-taxonomies")).filter(ot("discussions",!0)).forEach((function(e){t[e.slug()]=m.route.param(e.slug())}))})),(0,rt.extend)(pt().prototype,"requestParams",(function(t){var e=this;t.include.push("taxonomyTerms","taxonomyTerms.taxonomy"),j(n().store.all("flamarkt-taxonomies")).filter(ot("discussions",!0)).forEach((function(o){var n=e.params[o.slug()];n&&(t.filter.q?t.filter.q=(t.filter.q||"")+" taxonomy:"+o.slug()+":"+n:(t.filter.taxonomy=t.filter.taxonomy||{},t.filter.taxonomy[o.slug()]=n))}))})),(0,rt.extend)(vt().prototype,"infoItems",(function(t){var e=this.attrs.discussion.taxonomyTerms();e&&e.length&&t.add("taxonomies",H(e),10)})),(0,rt.extend)(Tt().prototype,"items",(function(t){var e=this.attrs.discussion.taxonomyTerms();e&&e.length&&t.add("taxonomies",H(e,{discussionLink:!0}),5)})),n().routes.flamarktTaxonomiesUser={path:"/u/:username/taxonomies",component:et},n().route.flamarktTaxonomiesUser=function(t){return n().route("flamarktTaxonomiesUser",{username:t.username()})},It()&&kt()&&((0,rt.extend)(It().prototype,"filters",(function(t){j(n().store.all("flamarkt-taxonomies")).filter(ot("products")).forEach((function(e){t.add("taxonomy-"+e.slug(),Y.component({taxonomy:e,activeTermSlug:m.route.param()[e.slug()],onchange:function(t){var o=_({},m.route.param());delete o.key;var r=o[e.slug()];t.slug()===r?delete o[e.slug()]:o[e.slug()]=t.slug();var s=n().current.data.routeName;m.route.set(n().route(s,o))}}))}))})),(0,rt.extend)(kt().prototype,"initState",(function(t){var e=m.route.param();j(n().store.all("flamarkt-taxonomies")).filter(ot("products",!0)).forEach((function(o){var n=e[o.slug()];n&&(t.params.q=(t.params.q||"")+" taxonomy:"+o.slug()+":"+n)}))}))),(0,rt.extend)(Lt(),"userControls",(function(t,e){e.attribute("canEditTaxonomies")&&j(n().forum.taxonomies()).forEach((function(o){"users"===o.type()&&t.add("taxonomy-"+o.slug(),v().component({icon:"fas fa-tag",onclick:function(){return n().modal.show(R,{resource:e,taxonomy:o})}},n().translator.trans("flamarkt-taxonomies.forum.user.edit",{taxonomy:o.name()})))}))})),(0,rt.extend)(tt().prototype,"navItems",(function(t){j(n().forum.taxonomies()).some((function(t){return"users"===t.type()}))&&t.add("taxonomies",Et().component({href:n().route.flamarktTaxonomiesUser(this.user),icon:"fas fa-tags"},n().translator.trans("flamarkt-taxonomies.forum.user.nav")),120)})),f().store.models["flamarkt-taxonomies"]=G,f().store.models["flamarkt-taxonomy-terms"]=q,Dt().prototype.taxonomies=N().hasMany("taxonomies"),At().prototype.taxonomyTerms=N().hasMany("taxonomyTerms"),Nt().prototype.taxonomyTerms=N().hasMany("taxonomyTerms"),Mt()&&(Mt().prototype.taxonomyTerms=N().hasMany("taxonomyTerms")),function(){if(flarum.extensions["fof-user-directory"]&&flarum.extensions["fof-user-directory"].searchTypes&&flarum.extensions["fof-user-directory"].searchTypes.AbstractType&&flarum.extensions["fof-user-directory"].components&&flarum.extensions["fof-user-directory"].components.SearchField){var t=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),r=0;r<o;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).allTerms=null,e.loadingAllTermsPromise=null,e.loading=!1,e.suggestions=[],e}s(e,t);var o=e.prototype;return o.resourceType=function(){return"flamarkt-taxonomy-terms"},o.search=function(t){var e=this;this.loading=!0,this.loadTerms().then((function(){e.loading=!1,e.suggestions=[],t?(t=t.toLowerCase(),e.allTerms.forEach((function(o){-1!==o.name().toLowerCase().indexOf(t)&&e.suggestions.push(o)})),m.redraw()):m.redraw()}))},o.loadTerms=function(){var t=this;if(this.loadingAllTermsPromise)return this.loadingAllTermsPromise;if(null!==this.allTerms)return Promise.resolve(null);this.allTerms=[];var e=[];return n().store.all("flamarkt-taxonomies").filter(ot("users")).forEach((function(o){e.push(n().request({method:"GET",url:n().forum.attribute("apiUrl")+o.apiEndpoint()+"/terms"}).then((function(e){var r,s=n().store.pushPayload(e);s.forEach((function(t){t.pushData({relationships:{taxonomy:o}})})),(r=t.allTerms).push.apply(r,s)})))})),this.loadingAllTermsPromise=Promise.all(e),this.loadingAllTermsPromise.then((function(){t.loadingAllTermsPromise=null}))},o.renderKind=function(t){var e=t.taxonomy();return e&&e.name()},o.renderLabel=function(t){return m(".UserDirectorySearchLabel",t.color()?{className:"colored",style:{backgroundColor:t.color()}}:{},[t.icon()?[c()(t.icon())," "]:null,t.name()])},o.applyFilter=function(t,e){t.q=t.q?t.q+" ":"",t.q+="taxonomy:"+e.taxonomy().slug()+":"+e.slug()},o.initializeFromParams=function(t){var e=this;if(!t.q)return Promise.resolve([]);var o=t.q.split(" ").filter((function(t){return 0===t.indexOf("taxonomy:")}));return o.length?this.loadTerms().then((function(){var t=[];return o.forEach((function(o){var n=o.split(":");if(!(n.length<3)){var r=e.allTerms.find((function(t){return t.slug()===n[2]&&t.taxonomy().slug()===n[1]}));r&&t.push(r)}})),t})):Promise.resolve([])},e}(flarum.extensions["fof-user-directory"].searchTypes.AbstractType);(0,rt.extend)(flarum.extensions["fof-user-directory"].components.SearchField.prototype,"filterTypes",(function(e){e.add("flamarkt-taxonomies",new t,15)}))}}()})),n().initializers.add("flamarkt-taxonomies-delayed",(function(){(0,rt.extend)(at().prototype,"headerItems",(function(t){this.taxonomiesHeaderItemsCount=Object.keys(t.toObject()).length}))}),-500)})(),module.exports=e})();
//# sourceMappingURL=forum.js.map